generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  agenticMode Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects      Project[]
  invoices      Invoice[]
  creditBalance CreditBalance?
  cloudConnections CloudConnection[]
  agentSessions    AgentSession[]
  deploymentCredentials DeploymentCredential[]
  deployments      Deployment[]
  githubConnections GitHubConnection[]
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  templates Template[]
}

model Template {
  id        String   @id @default(uuid())
  name      String
  content   String   // Terraform code
  provider  String   // aws, azure, gcp, etc.
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project      Project       @relation(fields: [projectId], references: [id])
  violations   Violation[]
  auditReports AuditReport[]
  versions     TemplateVersion[]
  agentSessions AgentSession[]
  deployments  Deployment[]
  repoLinks    TemplateRepoLink[]
}

model Invoice {
  id        String   @id @default(uuid())
  amount    Float
  status    String   // PENDING, PAID, OVERDUE
  date      DateTime @default(now())
  pdfUrl    String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
}

// ============================================================================
// POLICY ENGINE MODELS
// ============================================================================

model Policy {
  id          String         @id @default(uuid())
  code        String         @unique // e.g., SEC001, COST001
  name        String
  description String?
  provider    String         // aws, azure, gcp, all
  category    PolicyCategory
  severity    Severity
  ruleLogic   Json           // Rule definition (conditions, checks)
  isBuiltIn   Boolean        @default(false)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  violations  Violation[]
}

model Violation {
  id            String   @id @default(uuid())
  templateId    String
  auditReportId String?
  policyId      String
  resourceRef   String   // e.g., "aws_s3_bucket.main"
  resourceType  String?  // e.g., "aws_s3_bucket"
  line          Int?
  message       String
  suggestion    String?
  autoFixable   Boolean  @default(false)
  createdAt     DateTime @default(now())

  template      Template    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  auditReport   AuditReport? @relation(fields: [auditReportId], references: [id], onDelete: Cascade)
  policy        Policy      @relation(fields: [policyId], references: [id])

  @@index([templateId])
  @@index([auditReportId])
  @@index([policyId])
}

model AuditReport {
  id            String   @id @default(uuid())
  templateId    String
  totalIssues   Int
  criticalCount Int      @default(0)
  highCount     Int      @default(0)
  mediumCount   Int      @default(0)
  lowCount      Int      @default(0)
  passedChecks  Int      @default(0)
  score         Float    // 0-100 security/compliance score
  summary       String?  // AI-generated summary
  createdAt     DateTime @default(now())

  template      Template    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  violations    Violation[]

  @@index([templateId])
}

enum PolicyCategory {
  SECURITY
  COST
  RELIABILITY
  PERFORMANCE
  COMPLIANCE
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

// ============================================================================
// CREDITS & BILLING MODELS
// ============================================================================

model CreditBalance {
  id            String   @id @default(uuid())
  userId        String   @unique
  balance       Int      @default(0) // Current credit balance
  lifetimeUsed  Int      @default(0) // Total credits ever used
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
  transactions  CreditTransaction[]
}

model CreditTransaction {
  id              String          @id @default(uuid())
  creditBalanceId String
  amount          Int             // Positive = purchase, Negative = usage
  type            TransactionType
  description     String          // "Template Generation", "Audit Scan", etc.
  referenceId     String?         // Related templateId, auditId, etc.
  stripePaymentId String?         // For purchases
  createdAt       DateTime        @default(now())

  creditBalance   CreditBalance   @relation(fields: [creditBalanceId], references: [id])

  @@index([creditBalanceId])
  @@index([createdAt])
}

enum TransactionType {
  PURCHASE        // Bought credits
  GENERATION      // Used for template generation
  AUDIT           // Used for audit scan
  COST_ANALYSIS   // Used for cost analysis
  CLOUD_SCAN      // Used for cloud resource scan
  RECOMMENDATION  // Used for AI recommendation
  AGENT_ANALYSIS  // Used for agentic analysis (audit + cost + remediation)
  DEPLOY_PLAN     // Used for terraform plan
  DEPLOY_APPLY    // Used for terraform apply
  GITHUB_SYNC     // Used for GitHub push/pull operations
  BONUS           // Promotional credits
  REFUND          // Refunded credits
}


// ============================================================================
// CLOUD INTEGRATION MODELS
// ============================================================================

model CloudConnection {
  id            String         @id @default(uuid())
  userId        String
  provider      String         // aws, azure, gcp
  name          String         // "Production AWS", "Dev Account"
  
  // AWS
  awsRoleArn    String?        // Cross-account role ARN
  awsExternalId String?        // Security external ID
  
  // Azure
  azureTenantId String?
  azureClientId String?
  
  // GCP
  gcpProjectId  String?
  gcpKeyPath    String?        // Encrypted reference
  
  status        ConnectionStatus @default(PENDING)
  lastSyncAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user          User           @relation(fields: [userId], references: [id])
  resources     CloudResource[]
  recommendations Recommendation[]

  @@index([userId])
}

model CloudResource {
  id              String   @id @default(uuid())
  connectionId    String
  resourceType    String   // vpc, subnet, rds, etc.
  resourceId      String   // AWS ARN or resource ID
  name            String?
  region          String
  metadata        Json     // Provider-specific details
  lastSyncedAt    DateTime @default(now())

  connection      CloudConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([resourceType])
}

enum ConnectionStatus {
  PENDING
  ACTIVE
  FAILED
  DISCONNECTED
}

// ============================================================================
// RECOMMENDATION ENGINE MODELS
// ============================================================================

model Recommendation {
  id              String               @id @default(uuid())
  connectionId    String
  resourceId      String?              // Optional: link to specific resource
  type            RecommendationType
  title           String
  description     String
  impact          String               // JSON: { savings: 120, risk: "low" }
  effort          EffortLevel
  status          RecommendationStatus @default(OPEN)
  dismissedAt     DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  connection      CloudConnection      @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([status])
}

enum RecommendationType {
  COST
  SECURITY
  PERFORMANCE
  RELIABILITY
}

enum RecommendationStatus {
  OPEN
  APPLIED
  DISMISSED
}

enum EffortLevel {
  LOW
  MEDIUM
  HIGH
}

// ============================================================================
// AGENTIC AUTOMATION MODELS
// ============================================================================

model TemplateVersion {
  id          String   @id @default(uuid())
  templateId  String
  version     Int
  content     String   // Full template content at this version
  changeLog   String?  // What changed
  createdBy   String   // "user" or "agent"
  createdAt   DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
}

model AgentSession {
  id              String   @id @default(uuid())
  userId          String
  templateId      String
  status          AgentSessionStatus @default(PLANNING)
  changePlan      Json?    // Array of proposed changes (AgentChange[])
  appliedChanges  Json?    // Array of accepted change IDs
  originalScore   Json?    // { security: number, cost: number }
  projectedScore  Json?    // { security: number, cost: number }
  totalSavings    Float    @default(0)
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  user     User     @relation(fields: [userId], references: [id])
  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateId])
}

enum AgentSessionStatus {
  PLANNING
  REVIEWING
  APPLYING
  COMPLETED
  CANCELLED
}

model DeploymentCredential {
  id          String   @id @default(uuid())
  userId      String
  provider    String   // "aws"
  roleArn     String   // Encrypted
  externalId  String
  name        String   // e.g., "Production Account"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id])
  deployments Deployment[]
  repoLinks   TemplateRepoLink[]

  @@index([userId])
}

model Deployment {
  id              String           @id @default(uuid())
  userId          String
  templateId      String
  credentialId    String
  region          String           @default("us-east-1")
  status          DeploymentStatus @default(PLANNING)
  planOutput      Json?            // Parsed plan summary
  applyOutput     String?          // Apply logs
  stateFile       String?          // Encrypted Terraform state
  resourceCount   Int              @default(0)
  estimatedCost   Float?
  errorMessage    String?
  createdAt       DateTime         @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  commitSha       String?           // Git commit that triggered deploy
  sourceBranch    String?           // Branch deployed from
  repoLinkId      String?

  user       User                 @relation(fields: [userId], references: [id])
  template   Template             @relation(fields: [templateId], references: [id], onDelete: Cascade)
  credential DeploymentCredential @relation(fields: [credentialId], references: [id])
  repoLink   TemplateRepoLink?    @relation(fields: [repoLinkId], references: [id])

  @@index([userId])
  @@index([templateId])
  @@index([credentialId])
}

enum DeploymentStatus {
  PLANNING
  PLAN_READY
  APPLYING
  SUCCEEDED
  FAILED
  DESTROYING
  DESTROYED
}

// ============================================================================
// GITHUB INTEGRATION MODELS
// ============================================================================

model GitHubConnection {
  id              String   @id @default(uuid())
  userId          String
  installationId  String?  // GitHub App installation ID
  accessToken     String   // Encrypted personal access token or installation token
  tokenExpiresAt  DateTime?
  githubUsername  String
  avatarUrl       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])
  repositories    GitHubRepo[]

  @@unique([userId, githubUsername])
  @@index([userId])
}

model GitHubRepo {
  id              String   @id @default(uuid())
  connectionId    String
  repoOwner       String   // "AhmadBarake"
  repoName        String   // "my-infra"
  fullName        String   // "AhmadBarake/my-infra"
  defaultBranch   String   @default("main")
  isPrivate       Boolean  @default(true)
  lastSyncedAt    DateTime?
  lastCommitSha   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  connection      GitHubConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  templateLinks   TemplateRepoLink[]

  @@unique([connectionId, fullName])
  @@index([connectionId])
}

model TemplateRepoLink {
  id              String        @id @default(uuid())
  templateId      String
  repoId          String
  branch          String        @default("main")
  filePath        String        @default("main.tf") // Path within repo
  syncDirection   SyncDirection @default(PUSH)
  autoSync        Boolean       @default(false) // Auto-push on template save
  autoDeploy      Boolean       @default(false) // Auto-deploy on repo push
  credentialId    String?       // DeploymentCredential for auto-deploy
  region          String?       // Region for auto-deploy
  lastPushAt      DateTime?
  lastPullAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  template        Template             @relation(fields: [templateId], references: [id], onDelete: Cascade)
  repo            GitHubRepo           @relation(fields: [repoId], references: [id], onDelete: Cascade)
  credential      DeploymentCredential? @relation(fields: [credentialId], references: [id])
  deployments     Deployment[]

  @@unique([templateId, repoId])
  @@index([templateId])
  @@index([repoId])
}

enum SyncDirection {
  PUSH          // Chkmate → GitHub
  PULL          // GitHub → Chkmate
  BIDIRECTIONAL
}
